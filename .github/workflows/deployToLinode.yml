name: Deploy Discord Bot to Linode

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python # Keep this if you have local tests on the runner
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies (on runner, for potential tests) # Keep this if you have local tests on the runner
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan ${{ secrets.LINODE_HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    - name: Deploy to Linode and Restart Bot
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.LINODE_USERNAME }}@${{ secrets.LINODE_HOST }} << 'EOF'
          set -e # Exit on any error within this SSH block

          echo "üöÄ Starting deployment..."

          # Navigate to project directory
          cd /opt/discord-bot || { echo "‚ùå Failed to navigate to project directory"; exit 1; }

          # Stop the bot service before updating
          echo "‚èπÔ∏è Stopping Discord bot service..."
          # Usamos la ruta completa a systemctl para evitar problemas de PATH
          # Y asumimos que NOPASSWD ya est√° configurado
          /usr/bin/sudo -n /usr/bin/systemctl stop discord-bot || echo "‚ö†Ô∏è Service was not running or failed to stop, continuing."

          # Fix ownership issues (should be handled by prepare-server.sh, but good as a safeguard)
          echo "üîß Fixing file ownership (as safeguard)..."
          # Aqu√≠, NO USAMOS sudo si deployuser ya es el due√±o
          # Solo se ejecutar√≠a si los permisos se corrompieran (por root u otro proceso)
          /usr/bin/sudo -n /usr/bin/chown -R deployuser:deployuser /opt/discord-bot || echo "‚ö†Ô∏è Could not set ownership (might not be necessary)." # Added fallback

          # Handle git repository setup
          echo "üì• Setting up repository..."
          if [ ! -d ".git" ]; then
            echo "üîÑ No git repository found, cloning..."
            # Remove any existing files first (ensure it's safe)
            rm -rf /opt/discord-bot/* /opt/discord-bot/.[^.]* 2>/dev/null || true
            git clone https://github.com/${{ github.repository }}.git . || { echo "‚ùå Failed to clone repository"; exit 1; }
            git config --global --add safe.directory /opt/discord-bot
          else
            echo "üì¶ Updating existing repository..."
            # Ensure correct ownership before git operations (again, a safeguard)
            git config --global --add safe.directory /opt/discord-bot
            git clean -fdx  # Remove untracked files and directories
            git fetch origin main || { echo "‚ùå Failed to fetch latest changes"; exit 1; }
            git reset --hard origin/main || { echo "‚ùå Failed to reset to latest changes"; exit 1; }
          fi

          # Activate virtual environment
          echo "üêç Activating virtual environment..."
          # Aseg√∫rate de que el venv exista (prepare-server.sh lo crea)
          if [ ! -d "venv" ]; then
            echo "Creating virtual environment..."
            python3 -m venv venv || { echo "‚ùå Failed to create virtual environment"; exit 1; }
          fi
          source venv/bin/activate || { echo "‚ùå Failed to activate virtual environment"; exit 1; }

          # Update dependencies
          echo "üì¶ Installing/updating dependencies..."
          pip install --upgrade pip || { echo "‚ùå Failed to upgrade pip"; exit 1; }
          pip install -r requirements.txt || { echo "‚ùå Failed to install dependencies"; exit 1; }
          deactivate # No es necesario mantener el venv activo despu√©s de pip install

          # Create .env file with secrets
          echo "üîë Creating .env file with secrets..."
          # Esto es CR√çTICO. ¬°NUNCA pongas tus tokens directamente aqu√≠!
          # Usa los GitHub Secrets.
          echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" > .env
          echo "PREFIX=!" >> .env
          # Aseg√∫rate de que .env no tiene permisos de lectura para todos
          chmod 600 .env

          # Start the bot service
          echo "‚ñ∂Ô∏è Starting Discord bot service..."
          /usr/bin/sudo -n /usr/bin/systemctl start discord-bot || { echo "‚ùå Failed to start Discord bot service"; exit 1; }

          # Check service status
          echo "üîç Checking service status..."
          /usr/bin/sudo -n /usr/bin/systemctl is-active discord-bot --quiet && echo "‚úÖ Discord bot is running" || { echo "‚ùå Failed to start Discord bot"; exit 1; }

          echo "üéâ Deployment completed successfully!"
        EOF