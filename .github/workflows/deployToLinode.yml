name: Deploy Discord Bot to Linode

on:
  pu          # Handle git repository setup
          echo "üì• Setting up repository..."
          if [ ! -d ".git" ]; then
            echo "üîÑ No git repository found, cloning..."
            # Remove any existing files first
            rm -rf * .[^.]* 2>/dev/null || true
            git clone https://github.com/esedesofiaaa/DiscordSelfBotting.git .
            git config --global --add safe.directory /opt/discord-bot
          else
            echo "üì¶ Updating existing repository..."
            # Fix git ownership issues
            git config --global --add safe.directory /opt/discord-bot
            git fetch origin main
            git reset --hard origin/main
          fiches:
      - main
  workflow_dispatch: # Permite ejecutar manualmente el workflow

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        # Agregar host a known_hosts de forma segura
        ssh-keyscan -H ${{ secrets.LINODE_HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    - name: Test SSH Connection
      run: |
        ssh -o ConnectTimeout=10 ${{ secrets.LINODE_USERNAME }}@${{ secrets.LINODE_HOST }} "echo 'SSH connection successful'"

    - name: Deploy to Linode
      run: |
        ssh ${{ secrets.LINODE_USERNAME }}@${{ secrets.LINODE_HOST }} << 'EOF'
          set -e  # Exit on any error
          
          echo "üöÄ Starting deployment..."
          
          # Navigate to project directory
          cd /opt/discord-bot || { echo "‚ùå Failed to navigate to project directory"; exit 1; }
          
          # Stop the bot service before updating
          echo "‚èπÔ∏è Stopping Discord bot service..."
          sudo systemctl stop discord-bot || echo "‚ö†Ô∏è Service was not running"
          
          # Handle git repository setup
          echo "üì• Setting up repository..."
          if [ ! -d ".git" ]; then
            echo "ÔøΩ No git repository found, cloning..."
            # Remove any existing files first
            rm -rf * .[^.]* 2>/dev/null || true
            git clone https://github.com/esedesofiaaa/DiscordSelfBotting.git .
          else
            echo "üì¶ Updating existing repository..."
            git fetch origin main
            git reset --hard origin/main
          fi
          
          # Activate virtual environment
          echo "üêç Activating virtual environment..."
          source venv/bin/activate || { echo "‚ùå Failed to activate virtual environment"; exit 1; }
          
          # Update dependencies
          echo "üì¶ Installing/updating dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Start the bot service
          echo "‚ñ∂Ô∏è Starting Discord bot service..."
          sudo systemctl start discord-bot
          
          # Check service status
          echo "üîç Checking service status..."
          sudo systemctl is-active discord-bot --quiet && echo "‚úÖ Discord bot is running" || { echo "‚ùå Failed to start Discord bot"; exit 1; }
          
          echo "üéâ Deployment completed successfully!"
        EOF

    - name: Verify Deployment
      run: |
        echo "üîç Verifying deployment status..."
        ssh ${{ secrets.LINODE_USERNAME }}@${{ secrets.LINODE_HOST }} "
          sudo systemctl status discord-bot --no-pager -l
        "
