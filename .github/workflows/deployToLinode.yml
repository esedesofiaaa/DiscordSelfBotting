name: Deploy Discord Message Listener to Linode

on:
  push:
    branches:
      - main # Solo deploy desde main
    paths-ignore:
      - "README_SIMPLE_LISTENER.md"
      - "docs/**"
      - "*.md"
      - ".github/workflows/**"
      - ".gitignore"
      - ".vscode/**"
      - "test/**"
  workflow_dispatch: # Permite deployment manual
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan ${{ secrets.LINODE_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to Linode and Restart Message Listener
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.LINODE_USERNAME }}@${{ secrets.LINODE_HOST }} << 'EOF'
            set -e # Exit on any error within this SSH block

            echo "üöÄ Starting deployment..."

            # Navigate to project directory (use existing directory)
            cd /opt/discord-bot || { echo "‚ùå Failed to navigate to project directory"; exit 1; }

            # Stop the message listener service before updating
            echo "‚èπÔ∏è Stopping Discord bot services..."
            /usr/bin/sudo -n /usr/bin/systemctl stop discord-bot || echo "‚ö†Ô∏è Service discord-bot was not running or failed to stop, continuing."
            /usr/bin/sudo -n /usr/bin/systemctl stop discord-inactivity-monitor || echo "‚ö†Ô∏è Service discord-inactivity-monitor was not running or failed to stop, continuing."

            # Fix ownership issues (should be handled by prepare-server.sh, but good as a safeguard)
            echo "üîß Fixing file ownership (as safeguard)..."
            /usr/bin/sudo -n /usr/bin/chown -R deployuser:deployuser /opt/discord-bot || echo "‚ö†Ô∏è Could not set ownership (might not be necessary)."

            # Handle git repository setup
            echo "üì• Setting up repository..."
            if [ ! -d ".git" ]; then
              echo "üîÑ No git repository found, cloning..."
              # Remove any existing files first (ensure it's safe)
              rm -rf /opt/discord-bot/* /opt/discord-bot/.[^.]* 2>/dev/null || true
              git clone https://github.com/${{ github.repository }}.git . || { echo "‚ùå Failed to clone repository"; exit 1; }
              git config --global --add safe.directory /opt/discord-bot
            else
              echo "üì¶ Updating existing repository..."
              # Ensure correct ownership before git operations (again, a safeguard)
              git config --global --add safe.directory /opt/discord-bot
              git clean -fdx -e token.pickle -e credentials.json # Remove untracked files but KEEP OAuth credentials
              git fetch origin main || { echo "‚ùå Failed to fetch latest changes"; exit 1; }
              git reset --hard origin/main || { echo "‚ùå Failed to reset to latest changes"; exit 1; }
            fi

            # Activate virtual environment
            echo "üêç Activating virtual environment..."
            # Aseg√∫rate de que el venv exista (prepare-server.sh lo crea)
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment..."
              python3 -m venv venv || { echo "‚ùå Failed to create virtual environment"; exit 1; }
            fi
            source venv/bin/activate || { echo "‚ùå Failed to activate virtual environment"; exit 1; }

            # Update dependencies
            echo "üì¶ Installing/updating dependencies..."
            pip install --upgrade pip || { echo "‚ùå Failed to upgrade pip"; exit 1; }
            pip install -r requirements.txt || { echo "‚ùå Failed to install dependencies"; exit 1; }
            deactivate # No es necesario mantener el venv activo despu√©s de pip install

            # Create .env file with secrets
            echo "üîë Creating .env file with secrets..."
            echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" > .env
            echo "MONITORING_SERVER_ID=${{ vars.MONITORING_SERVER_ID }}" >> .env
            echo "MONITORING_CHANNEL_IDS=${{ vars.MONITORING_CHANNEL_IDS }}" >> .env
            echo "LOG_FILE=./logs/messages.json" >> .env
            echo "NOTION_TOKEN=${{ secrets.NOTION_TOKEN }}" >> .env
            echo "NOTION_DATABASE_ID=${{ vars.NOTION_DATABASE_ID }}" >> .env
            echo "HEALTHCHECKS_PING_URL=${{ secrets.HEALTHCHECKS_PING_URL }}" >> .env
            echo "HEARTBEAT_INTERVAL=${{ vars.HEARTBEAT_INTERVAL }}" >> .env
            echo "MONITOR_INTERVAL=${{ vars.MONITOR_INTERVAL }}" >> .env
            echo "BOT_PROCESS_NAME=${{ vars.BOT_PROCESS_NAME }}" >> .env
            echo "AUTO_RESTART_BOT=${{ vars.AUTO_RESTART_BOT }}" >> .env
            echo "GOOGLE_DRIVE_ENABLED=${{ vars.GOOGLE_DRIVE_ENABLED }}" >> .env
            echo "GOOGLE_DRIVE_FOLDER_ID=${{ vars.GOOGLE_DRIVE_FOLDER_ID }}" >> .env
            
            # Email Notification Configuration
            echo "SMTP_SERVER=${{ vars.SMTP_SERVER }}" >> .env
            echo "SMTP_PORT=${{ vars.SMTP_PORT }}" >> .env
            echo "SMTP_SENDER_EMAIL=${{ secrets.SMTP_SENDER_EMAIL }}" >> .env
            echo "SMTP_SENDER_PASSWORD=${{ secrets.SMTP_SENDER_PASSWORD }}" >> .env
            echo "ALERT_RECIPIENT_EMAILS=${{ secrets.ALERT_RECIPIENT_EMAILS }}" >> .env
            echo "INACTIVITY_THRESHOLD_HOURS=${{ vars.INACTIVITY_THRESHOLD_HOURS }}" >> .env
            echo "INACTIVITY_CHECK_INTERVAL_MINUTES=${{ vars.INACTIVITY_CHECK_INTERVAL_MINUTES }}" >> .env

            # Add OAuth 2.0 configuration (Files must be uploaded manually to server)
            echo "GOOGLE_DRIVE_CREDENTIALS_FILE=credentials.json" >> .env
            echo "GOOGLE_DRIVE_TOKEN_FILE=token.pickle" >> .env
            echo "GOOGLE_SERVICE_ACCOUNT_FILE=service_account.json" >> .env
            
            # Create Service Account credentials file if Google Drive is enabled (Fallback)
            if [ "${{ vars.GOOGLE_DRIVE_ENABLED }}" = "true" ] && [ -n "${{ secrets.GOOGLE_SERVICE_ACCOUNT_FILE }}" ]; then
              echo "üîë Creating Google Drive Service Account file (Fallback)..."
              echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_FILE }}' > service_account.json
              chmod 600 service_account.json
            fi
            
            # Aseg√∫rate de que .env no tiene permisos de lectura para todos
            chmod 600 .env

            # Update service configuration
            echo "üîß Updating service configuration..."
            /usr/bin/sudo -n cp discord-bot.service /etc/systemd/system/
            /usr/bin/sudo -n cp discord-inactivity-monitor.service /etc/systemd/system/
            /usr/bin/sudo -n systemctl daemon-reload

            # Start the message listener service
            echo "‚ñ∂Ô∏è Starting Discord bot service..."
            /usr/bin/sudo -n /usr/bin/systemctl start discord-bot || { echo "‚ùå Failed to start Discord bot service"; exit 1; }
            
            # Start the inactivity monitor service
            echo "‚ñ∂Ô∏è Starting Inactivity Monitor service..."
            /usr/bin/sudo -n /usr/bin/systemctl enable discord-inactivity-monitor
            /usr/bin/sudo -n /usr/bin/systemctl restart discord-inactivity-monitor || { echo "‚ùå Failed to start Inactivity Monitor service"; exit 1; }

            # Check service status
            echo "üîç Checking service status..."
            /usr/bin/sudo -n /usr/bin/systemctl is-active discord-bot --quiet && echo "‚úÖ Discord bot is running" || { echo "‚ùå Failed to start Discord bot"; exit 1; }
            /usr/bin/sudo -n /usr/bin/systemctl is-active discord-inactivity-monitor --quiet && echo "‚úÖ Inactivity Monitor is running" || { echo "‚ùå Failed to start Inactivity Monitor"; exit 1; }

            echo "üéâ Deployment completed successfully!"
          EOF
